{
  "variables": {
    "bot_token": "{{env `BOT_TOKEN`}}",
    "bot_chat_id": "{{env `BOT_CHAT_ID`}}",
    "chat_id": "{{env `CHAT_ID`}}",
    "youtube_key": "{{env `YOUTUBE_KEY`}}",
    "alicloud_access_key": "{{env `ALICLOUD_ACCESS_KEY`}}",
    "alicloud_secret_key": "{{env `ALICLOUD_SECRET_KEY`}}",
    "alicloud_region": "{{env `ALICLOUD_REGION`}}",
    "docker_id": "{{env `DOCKER_ID`}}",

    "youtube_audio_source_file": "bin/youtube-audio",
    "youtube_dl_source_file": "bin/dependency/youtube-dl",
    "configure_source_file": "deploy/script/configure.sh",
    "start_source_file": "deploy/script/start.sh",

    "youtube_audio_target_file": "/app/youtube-audio",
    "youtube_dl_target_file": "/usr/local/sbin/youtube-dl",
    "configure_target_file": "/configure.sh",
    "start_target_file": "/start.sh",

    "tmp_dir": "/tmp"
  },
  "builders": [{
    "type":"docker",
    "image":"centos:centos7.9.2022.07",
    "commit": true,
    "pull": false,
    "changes": [
      "ENV LANG zh_CN.UTF-8",
      "ENV LANGUAGE zh_CN.UTF-8",
      "ENV BOT_TOKEN {{ user `bot_token` }}",
      "ENV BOT_CHAT_ID {{ user `bot_chat_id` }}",
      "ENV CHAT_ID {{ user `chat_id` }}",
      "ENV YOUTUBE_KEY {{ user `youtube_key` }}",
      "ENV ALICLOUD_ACCESS_KEY {{ user `alicloud_access_key` }}",
      "ENV ALICLOUD_SECRET_KEY {{ user `alicloud_secret_key` }}",
      "ENV ALICLOUD_REGION {{ user `alicloud_region` }}",
      "ENV DOCKER_ID {{ user `docker_id` }}"
    ]
  }],
  "provisioners": [
    {
      "type": "file",
      "source": "{{user `youtube_audio_source_file`}}",
      "destination": "{{user `youtube_audio_target_file`}}"
    },
    {
      "type": "file",
      "source": "{{user `youtube_dl_source_file`}}",
      "destination": "{{user `youtube_dl_target_file`}}"
    },
    {
      "type": "file",
      "source": "{{user `configure_source_file`}}",
      "destination": "{{user `configure_target_file`}}"
    },
    {
      "type": "file",
      "source": "{{user `start_source_file`}}",
      "destination": "{{user `start_target_file`}}"
    },
    {
      "type": "shell",
      "scripts": [
        "{{user `configure_source_file`}}",
        "{{user `start_source_file`}}"
      ],
      "environment_vars": [
        "FOO={{ user `tmp_dir` }}"
      ]
    }
  ],
  "post-processors": [
    [
      {
        "type": "docker-tag",
        "repository": "{{user `docker_id`}}/youtube-audio",
        "tags": [
          "v0.1.6"
        ]
      },
      "docker-push"
    ]
  ]
}