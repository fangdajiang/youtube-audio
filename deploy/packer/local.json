{
  "variables": {
    "bot_token": "{{env `BOT_TOKEN`}}",
    "bot_chat_id": "{{env `BOT_CHAT_ID`}}",
    "chat_id": "{{env `CHAT_ID`}}",
    "youtube_key": "{{env `YOUTUBE_KEY`}}",
    "docker_id": "{{env `DOCKER_ID`}}",

    "fetch_base_source_file": "resource/fetch_base.json",
    "fetch_history_source_file": "resource/fetch_history.json",
    "youtube_dl_source_file": "dependency/youtube-dl",
    "configure_source_file": "deploy/script/configure.sh",
    "start_source_file": "deploy/script/start.sh",
    "youtube_audio_source_file": "youtube-audio",

    "fetch_base_target_file": "/fetch_base.json",
    "fetch_history_target_file": "/fetch_history.json",
    "youtube_dl_target_file": "/usr/local/sbin/youtube-dl",
    "configure_target_file": "/configure.sh",
    "start_target_file": "/start.sh",
    "youtube_audio_target_file": "/youtube-audio",

    "tmp_dir": "/tmp"
  },
  "builders": [{
    "type":"docker",
    "image":"centos:centos7.9.2022.07",
    "commit": true,
    "pull": false,
    "changes": [
      "ENV APP_HOME /",
      "ENV BOT_TOKEN {{ user `bot_token` }}",
      "ENV BOT_CHAT_ID {{ user `bot_chat_id` }}",
      "ENV CHAT_ID {{ user `chat_id` }}",
      "ENV YOUTUBE_KEY {{ user `youtube_key` }}"
    ]
  }],
  "provisioners": [
    {
      "type": "file",
      "source": "{{user `fetch_base_source_file`}}",
      "destination": "{{user `fetch_base_target_file`}}"
    },
    {
      "type": "file",
      "source": "{{user `fetch_history_source_file`}}",
      "destination": "{{user `fetch_history_target_file`}}"
    },
    {
      "type": "file",
      "source": "{{user `youtube_audio_source_file`}}",
      "destination": "{{user `youtube_audio_target_file`}}"
    },
    {
      "type": "file",
      "source": "{{user `youtube_dl_source_file`}}",
      "destination": "{{user `youtube_dl_target_file`}}"
    },
    {
      "type": "file",
      "source": "{{user `configure_source_file`}}",
      "destination": "{{user `configure_target_file`}}"
    },
    {
      "type": "file",
      "source": "{{user `start_source_file`}}",
      "destination": "{{user `start_target_file`}}"
    },
    {
      "type": "shell",
      "scripts": [
        "{{user `configure_source_file`}}",
        "{{user `start_source_file`}}"
      ],
      "environment_vars": [
        "FOO={{ user `tmp_dir` }}"
      ]
    }
  ],
  "post-processors": [
    [
      {
        "type": "docker-tag",
        "repository": "{{user `docker_id`}}/youtube-audio",
        "tags": [
          "v0.1.4"
        ]
      },
      "docker-push"
    ]
  ]
}